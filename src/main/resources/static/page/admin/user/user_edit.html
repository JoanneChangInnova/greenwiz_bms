<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>編輯用戶</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../lib/layui-v2.6.3/css/layui.css" media="all">
    <style>
        body {
            background-color: #ffffff;
        }
    </style>
</head>
<body>
<div class="layui-form layuimini-form">
    <div class="layui-form-item">

        <div class="layui-form-item">
            <label class="layui-form-label required">用戶ID</label>
            <div class="layui-input-block">
                <input type="text" name="id" lay-verify="required" class="layui-input"
                       id="id" readonly>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label required">用戶名稱</label>
            <div class="layui-input-block">
                <input type="text" name="username" lay-verify="required" placeholder="請輸入用戶名稱" class="layui-input" id="username">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label required">角色</label>
            <div class="layui-input-block">
                <select name="role" lay-verify="required" id="role" lay-filter="role">
                    <option value="">請選擇角色</option>
                    <option value="0">管理員</option>
                    <option value="1">代理商</option>
                    <option value="2">安裝商</option>
                    <option value="3">一般用戶</option>
                </select>
            </div>
        </div>

    <div class="layui-form-item">
        <label class="layui-form-label required">用戶管理者</label>
        <div class="layui-input-block">
            <select name="parentId" lay-verify="required" id="parentId" lay-verify="required" lay-search="{caseSensitive:false, fuzzy: true}">
                <option value="">請選擇管理者</option>
                <!-- 動態載入 API 返回的數據 -->
            </select>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">信箱</label>
        <div class="layui-input-block">
            <input type="email" name="email" lay-verify="email" placeholder="請輸入電子郵件地址" value="" class="layui-input" id="email">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">公司名稱</label>
        <div class="layui-input-block">
            <input type="text" name="company" placeholder="請輸入公司名稱" value="" class="layui-input" id="company" >
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">公司聯絡人</label>
        <div class="layui-input-block">
            <input type="text" name="contact" placeholder="請輸入聯絡人名稱" value="" class="layui-input"  id="contact" >
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">電話國碼</label>
        <div class="layui-input-block">
            <input type="text" name="phoneCountryCode" placeholder="請輸入電話國碼" value="" class="layui-input" id="phoneCountryCode">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">電話號碼</label>
        <div class="layui-input-block">
            <input type="text" name="phoneNumber" placeholder="請輸入電話號碼" value="" class="layui-input" id="phoneNumber" >
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">國家</label>
        <div class="layui-input-block">
            <select name="country" lay-verify="required"  id="country">
                <option value="">請選擇國家</option>
                <option value="TWN">台灣</option>
                <option value="MYS">馬來西亞</option>
            </select>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">地址</label>
        <div class="layui-input-block">
            <input type="text" name="address" placeholder="請輸入地址" value="" class="layui-input"  id="address" >
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">工廠</label>
        <div class="layui-input-block">
            <select name="factoryId" id="factoryId">
                <option value="">請選擇工廠</option>
                <!-- 動態載入 API 返回的數據 -->
            </select>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">最大設備數量</label>
        <div class="layui-input-block">
            <select name="maxDevice"  id="maxDevice" >
                <option value="20">20</option>
                <option value="25">25</option>
                <option value="30">30</option>
                <option value="35">35</option>
                <option value="40">40</option>
                <option value="45">45</option>
                <option value="50">50</option>
            </select>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">語言偏好</label>
        <div class="layui-input-block">
            <select name="language" id="language">
                <option value="CHT">繁體中文</option>
                <option value="ENG">英文</option>
            </select>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">用戶狀態</label>
        <div class="layui-input-block">
            <input type="radio" name="state" value=0 title="待審">
            <input type="radio" name="state" value=1 title="開通">
            <input type="radio" name="state" value=2 title="封鎖">
        </div>
    </div>

    <input type="hidden" name="dtModify" class="layui-input" id="dtModify">  <!-- 修改時間 -->

    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-normal" lay-submit lay-filter="saveBtn">確認保存</button>
<!--            <button class="layui-btn layui-btn-primary" id="cancelBtn" layuimini-tab-close="current">取消</button>-->
        </div>
    </div>
</div>

<script src="../../../lib/layui-v2.6.3/layui.js"></script>
<script src="/js/comm.js" charset="utf-8"></script>
<script>
    layui.use(['form', 'layer'], function () {
        var form = layui.form, layer = layui.layer, $ = layui.$;
        var userId = new URLSearchParams(window.location.search).get('id'); // 取得 URL 中的用戶 ID

        // 從後端 API 獲取用戶資料
        $.get('/api/v1/user/' + userId, function (data) {
            // 這裡假設後端返回的是用戶的詳細資料
            $("#id").val(data.id);
            $("#username").val(data.username);
            $("#role").val(data.role); // 假設角色是 1、2 或 3
	        $("#email").val(data.email);
	        $("#company").val(data.company);
	        $("#contact").val(data.contact);
	        $("#phoneCountryCode").val(data.phoneCountryCode);
	        $("#phoneNumber").val(data.phoneNumber);
	        $("#country").val(data.country);
	        $("#address").val(data.address);
	        $("#factoryId").val(data.factoryId);
	        $("#maxDevice").val(data.maxDevice);
	        $("#language").val(data.language);
            $("#state").val(data.state);
            $("input[name='state'][value='" + data.state + "']").prop("checked", true); // 自動勾選對應的 radio 按鈕
            $("#dtModify").val(data.dtModify);

            // 獲取 parentData，並動態生成下拉框選項
            var parentData = data.parentData; // 單一管理者數據
            var select = $("#parentId");
            select.empty(); // 清空選項
            select.append(new Option("請選擇管理者", "")); // 添加默認選項

            if (parentData) {
                // 插入單一管理者數據為選項
                var option = new Option(
                        parentData.username + " (" + parentData.email + ")", // 顯示文本
                        parentData.id // 選項值
                );
                select.append(option);

                // 設置選中值
                $("#parentId").val(parentData.id);
            }

            // 重新渲染表單
            form.render('select');
	        form.render(); // 渲染表單
        });

        // 當角色選擇改變時，動態載入管理者選單
        form.on('select(role)', function(data) {
            console.log("角色選擇改變:", data.value);
            var userRole = data.value; // 取得選中的角色值

            // 清空 parentId 選項
            var select = $("select[name='parentId']");
            select.empty();
            select.append(new Option("請選擇管理者", ""));

            if (userRole) {
                // 構造請求數據
                var requestData = JSON.stringify({ userRole: userRole });

                // 發送 POST 請求到後端，傳遞 userRole 參數
                $.ajax({
                    url: '/api/v1/user/listParentInfo',
                    type: 'POST',
                    contentType: 'application/json',
                    data: requestData,
                    success: function(data) {
                        console.log("成功調用 API:", data);

                        // 將返回的數據添加到 parentId 的選項中
                        data.forEach(function(item) {
                            select.append(new Option(item.username + " (" + item.email + ")", item.id));
                        });

                        // 重新渲染 select 元素，確保 layui 框架正確顯示
                        form.render('select');
                    },
                    error: function() {
                        // 如果請求失敗，顯示錯誤信息
                        alert('無法加載選項，請重試');
                    }
                });
            }
        });
        // 表單提交事件
        form.on('submit(saveBtn)', function (data) {
            console.log("提交數據:", data.field);

            $.ajax({
                url: '/api/v1/user/update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data.field),
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        layer.alert('用戶資料更新成功', {title: '提示'}, function () {
                            window.location.href = 'user_list.html';
                        });
                    } else {
                        layer.alert('更新失敗', {title: '錯誤'});
                    }
                },
                error: function (xhr) {
                    handleErrorResponse(xhr);
                }
            });

            return false; // 阻止默認提交行為
        });

    // // 綁定取消按鈕事件
    // $('#cancelBtn').on('click', function () {
    //     miniTab.deleteCurrentByIframe();
    // });
     });
</script>
</body>
</html>
