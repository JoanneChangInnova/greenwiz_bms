<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>編輯用戶</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../lib/layui-v2.6.3/css/layui.css" media="all">
    <!-- 添加 Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #ffffff;
        }
        /* 添加 Select2 樣式調整 */
        .select2-container--default {
            width: 100% !important;
        }
        .select2-container--default .select2-selection--multiple {
            min-height: 38px;
            border: 1px solid #e6e6e6;
            border-radius: 2px;
        }
        .select2-container--default.select2-container--focus .select2-selection--multiple {
            border-color: #009688 !important;
        }
        /* 添加唯讀欄位樣式 */
        .readonly-field {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<div class="layui-form layuimini-form">
    <div class="layui-form-item">
        <div class="layui-form-item">
            <label class="layui-form-label required">用戶ID</label>
            <div class="layui-input-block">
                <input type="text" name="id" lay-verify="required" class="layui-input readonly-field" id="id" readonly>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label required">用戶名稱</label>
            <div class="layui-input-block">
                <input type="text" name="username" lay-verify="required" placeholder="請輸入用戶名稱" class="layui-input" id="username">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label required">角色</label>
            <div class="layui-input-block">
                <select name="role" lay-verify="required" id="role" lay-filter="role" disabled>
                    <option value="">請選擇角色</option>
                    <option value="0">管理員</option>
                    <option value="1">代理商</option>
                    <option value="2">安裝商</option>
                    <option value="3">一般用戶</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label required">用戶管理者</label>
            <div class="layui-input-block">
                <select name="parentId" lay-verify="required" id="parentId" lay-verify="required"
                        lay-search="{caseSensitive:false, fuzzy: true}" disabled>
                    <option value="">請選擇管理者</option>
                </select>
            </div>
        </div>

        <!-- 使用 Select2 的綁定工廠欄位 -->
        <div class="layui-form-item" id="factorySelectContainer">
            <label class="layui-form-label">綁定工廠</label>
            <div class="layui-input-block">
                <select name="factoryIds[]" id="factorySelect" multiple="multiple" lay-ignore class="layui-hide"></select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">信箱</label>
            <div class="layui-input-block">
                <input type="email" name="email" lay-verify="email" placeholder="請輸入電子郵件地址" value="" class="layui-input" id="email">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">公司名稱</label>
            <div class="layui-input-block">
                <input type="text" name="company" placeholder="請輸入公司名稱" value="" class="layui-input" id="company">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">公司聯絡人</label>
            <div class="layui-input-block">
                <input type="text" name="contact" placeholder="請輸入聯絡人名稱" value="" class="layui-input" id="contact">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">電話國碼</label>
            <div class="layui-input-block">
                <input type="text" name="phoneCountryCode" placeholder="請輸入電話國碼" value="" class="layui-input" id="phoneCountryCode">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">電話號碼</label>
            <div class="layui-input-block">
                <input type="text" name="phoneNumber" placeholder="請輸入電話號碼" value="" class="layui-input" id="phoneNumber">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">國家</label>
            <div class="layui-input-block">
                <select name="country" lay-verify="required" id="country">
                    <option value="">請選擇國家</option>
                    <option value="TWN">台灣</option>
                    <option value="MYS">馬來西亞</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">地址</label>
            <div class="layui-input-block">
                <input type="text" name="address" placeholder="請輸入地址" value="" class="layui-input" id="address">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">最大設備數量</label>
            <div class="layui-input-block">
                <select name="maxDevice" id="maxDevice">
                    <option value="20">20</option>
                    <option value="25">25</option>
                    <option value="30">30</option>
                    <option value="35">35</option>
                    <option value="40">40</option>
                    <option value="45">45</option>
                    <option value="50">50</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">語言偏好</label>
            <div class="layui-input-block">
                <select name="language" id="language">
                    <option value="CHT">繁體中文</option>
                    <option value="ENG">英文</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">用戶狀態</label>
            <div class="layui-input-block">
                <input type="radio" name="state" value=0 title="待審">
                <input type="radio" name="state" value=1 title="開通">
                <input type="radio" name="state" value=2 title="封鎖">
            </div>
        </div>

        <input type="hidden" name="dtModify" class="layui-input" id="dtModify">  <!-- 修改時間 -->

        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn layui-btn-normal" lay-submit lay-filter="saveBtn">確認保存</button>
            </div>
        </div>
    </div>
</div>

<!-- Replace the script section -->
<script src="../../../lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="../../../lib/layui-v2.6.3/layui.js"></script>
<script src="/js/comm.js" charset="utf-8"></script>
<script>
    // Make jQuery available to layui
    layui.$ = $;
    
    layui.use(['form', 'layer'], function () {
        var form = layui.form, layer = layui.layer, $ = layui.$;
        var userId = new URLSearchParams(window.location.search).get('id'); // 取得 URL 中的用戶 ID
        var allParentInfo = {}; // 用於儲存所有角色的 ParentInfo
        var originalParentId = null; // 用於儲存原始的 parentId

        // 頁面載入時，獲取所有角色的 ParentInfo
        $.get('/api/v1/user/listAllParentInfo', function (data) {
            allParentInfo = data; // 儲存到變數中
            console.log("所有角色的 ParentInfo:", allParentInfo);

            // 載入用戶資料
            loadUserData();
        }).fail(function () {
            layer.msg('無法載入管理者資料，請重試');
        });

        // 在 loadUserData 函數中添加工廠相關處理
        function loadUserData() {
            $.get('/api/v1/user/' + userId, function (data) {
                console.log("取回的 factoryData" + data.factoryData);
                console.log("取回的 role" + data.role);
                $("#id").val(data.id);
                $("#username").val(data.username);
                $("#role").val(data.role);
                $("#email").val(data.email);
                $("#company").val(data.company);
                $("#contact").val(data.contact);
                $("#phoneCountryCode").val(data.phoneCountryCode);
                $("#phoneNumber").val(data.phoneNumber);
                $("#country").val(data.country);
                $("#address").val(data.address);
                $("#maxDevice").val(data.maxDevice);
                $("#language").val(data.language);
                $("#state").val(data.state);
                $("input[name='state'][value='" + data.state + "']").prop("checked", true);
                $("#dtModify").val(data.dtModify);

                // 設置 parentId 下拉選單，保留原始功能
                var select = $("#parentId");
                select.empty();
                select.append(new Option("請選擇管理者", ""));

                // 保留原始 parentData 的顯示
                if (data.parentData) {
                    var option = new Option(data.parentData.displayText, data.parentData.id);
                    select.append(option);
                    $("#parentId").val(data.parentData.id);
                    originalParentId = data.parentData.id; // 儲存原始 parentId
                }

                // 如果有角色，則根據角色載入 parentId 選項
                var userRole = $("#role").val();
                if (userRole && allParentInfo[userRole]) {
                    updateParentOptions(userRole, true); // 保留原始 parentId
                }

                // 初始化 Select2
                initializeSelect2($('#factorySelect'), {
                    placeholder: '請選擇工廠',
                    multiple: true
                });

                // 處理工廠選擇區域的顯示
                if (data.role === 3) {
                    console.log("角色為 3，顯示工廠選擇區域");
                    $("#factorySelectContainer").show();

                    // 初始化 Select2
                    initializeSelect2($('#factorySelect'), {
                        placeholder: '請選擇工廠',
                        multiple: true
                    });

                    // 如果有 parentId，先載入該安裝商的所有工廠
                    if (data.parentData && data.parentData.id) {
                        $.ajax({
                            url: '/api/v1/factory/findByInstallerId/' + data.parentData.id,
                            type: 'GET',
                            async: false, // 使用同步請求確保數據加載順序
                            success: function(factoryList) {
                                if (factoryList && factoryList.length > 0) {
                                    const factoryMap = new Map();
                                    factoryList.forEach(function(item) {
                                        factoryMap.set(item.factoryId, {
                                            id: item.factoryId,
                                            text: item.displayText
                                        });
                                    });
                                    updateSelect2Options($('#factorySelect'), factoryMap);
                                    
                                    // 設置已綁定的工廠為選中狀態
                                    if (data.factoryData && data.factoryData.length > 0) {
                                        const selectedIds = data.factoryData.map(f => f.factoryId);
                                        $('#factorySelect').val(selectedIds).trigger('change');
                                    }
                                }
                            }
                        });
                    }
                } else {
                    $("#factorySelectContainer").hide();
                }

                form.render('select');
                form.render();
                
                // 為禁用的 select 添加唯讀樣式
                $('.layui-select-disabled').addClass('readonly-field');
            }).fail(function () {
                layer.msg('無法載入用戶資料，請重試');
            });
        }

        // 根據角色更新 parentId 下拉選單
        function updateParentOptions(userRole, keepOriginal) {
            var select = $("#parentId");
            var currentValue = keepOriginal ? $("#parentId").val() : null; // 如果需要保留原始值，則使用當前值
            select.empty();
            select.append(new Option("請選擇管理者", ""));

            // 從 allParentInfo 中獲取對應角色的 ParentInfo
            if (userRole && allParentInfo[userRole]) {
                allParentInfo[userRole].forEach(function (item) {
                    select.append(new Option(item.displayText, item.id));
                });
            }

            // 如果需要保留原始 parentId，則設置回去
            if (keepOriginal && currentValue && select.find("option[value='" + currentValue + "']").length > 0) {
                $("#parentId").val(currentValue);
            } else if (!keepOriginal && originalParentId && select.find("option[value='" + originalParentId + "']").length > 0) {
                $("#parentId").val(originalParentId); // 恢復原始 parentId
            }

            form.render('select');
        }

        // 當角色選擇改變時，從 allParentInfo 中獲取資料
        form.on('select(role)', function (data) {
            console.log("角色選擇改變:", data.value);
            var userRole = data.value;
            updateParentOptions(userRole, false); // 角色改變時不保留當前選擇，恢復原始 parentId
        });

        // 表單提交事件
        form.on('submit(saveBtn)', function (data) {
            console.log("提交數據:", data.field);

            $.ajax({
                url: '/api/v1/user/update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data.field),
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        layer.alert('用戶資料更新成功', {title: '提示'}, function () {
                            parent.layui.miniTab.deleteCurrentByIframe();
                            // window.location.href = 'user_list.html';
                        });
                    } else {
                        handleErrorResponse(xhr);
                    }
                },
                error: function (xhr) {
                    handleErrorResponse(xhr);
                }
            });

            return false;
        });

    // Add loadFactoryDataByInstallerId function inside layui.use
    function loadFactoryDataByInstallerId(installerId) {
        if (!installerId) {
            $('#factorySelect').empty().trigger('change');
            return;
        }
    
        $.ajax({
            url: '/api/v1/factory/findByInstallerId/' + installerId,
            type: 'GET',
            success: function(data) {
                if (data && data.length > 0) {
                    const factoryData = data.map(item => ({
                        id: item.factoryId,
                        text: item.displayText
                    }));
                    updateSelect2Options($('#factorySelect'), factoryData, true);
                } else {
                    layer.msg('該安裝商尚無綁定工廠', {icon: 0});
                    $('#factorySelect').empty().trigger('change');
                }
            },
            error: function(xhr) {
                console.error('載入工廠數據失敗:', xhr);
                handleErrorResponse(xhr);
            }
        });
    }

    // Update the existing submit event handler to include factoryIds
    form.on('submit(saveBtn)', function (data) {
        var formData = data.field;
        formData.factoryIds = $('#factorySelect').val() || [];
    
        $.ajax({
            url: '/api/v1/user/update',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function (response, textStatus, xhr) {
                if (xhr.status === 200) {
                    layer.alert('用戶資料更新成功', {title: '提示'}, function () {
                        window.location.href = 'user_list.html';
                    });
                } else {
                    layer.alert('更新失敗', {title: '錯誤'});
                }
            },
            error: function (xhr) {
                handleErrorResponse(xhr);
            }
        });
        return false;
    });
    });
</script>
</body>
</html>